# 背景

当前程序主要功能是基于大量的`DataFrame`，进行不同的计算和处理。

由于在一开始就会加载所有的`DataFrame`到内存中，所以内存分配了`200G`，但这样会引发`Full GC`和`OOM`，因此，考虑基于堆外内存进行优化，因为`DataFrame`本身就是可预见的不需要`GC`，因此可以直接分配到堆外内存。

堆外内存的优势：

1. 启动超大内存（上百GB）的JVM需要很长时间，GC停留时间也会很长（分钟级）。使用堆外内存的话，可以极大地减小堆内存（只需要分配Remaining Heap那一块），使得 TaskManager 扩展到上百GB内存不是问题。
2. 高效的 IO 操作。堆外内存在写磁盘或网络传输时是 zero-copy，而堆内存的话，至少需要 copy 一次。
3. 堆外内存是进程间共享的。也就是说，即使JVM进程崩溃也不会丢失数据。这可以用来做故障恢复（Flink暂时没有利用起这个，不过未来很可能会去做）。

堆外内存的问题：

1. 堆内存的使用、监控、调试都要简单很多。堆外内存意味着更复杂更麻烦。
2. Flink 有时需要分配短生命周期的 `MemorySegment`，这个申请在堆上会更廉价。
3. 有些操作在堆内存上会快一点点。



# 参考

[Flink 原理与实现：内存管理](https://developer.aliyun.com/article/57815)

